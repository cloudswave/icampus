<style type="text/css">.D2{width:100%;height:100%;position:absolute;top:0;left:0;z-index:99}.D2 .DCont{*zoom:1}.D2 .bg{background:#FFF;position:absolute;top:0;left:0;width:100%;height:100%;filter:alpha(opacity=0);-moz-opacity:0;opacity:0;-height:expression(document.body.scrollHeight > document.body.offsetHeight ? document.body.scrollHeight : document.body.offsetHeight + "px")}.D2 iframe.cover_select{width:100%;height:100%;position:absolute;filter:alpha(opacity=0);-moz-opacity:0;opacity:0;z-index:-1;display:none;-display:}.D2 .DLoad{filter:alpha(opacity=50);-moz-opacity:0.5;opacity:0.5;position:absolute;z-index:5;background:url(http://mat1.gtimg.com/www/mb/images/loading.gif) #FFF 50% 50% no-repeat;}.D2 .CR{position:absolute;top:50%;left:50%;margin:0 0 0 -9999px}.D2 .DTitle,.D2 .ico_skin,.DtabTitle,.ico_lock,.D2 .funBoxx,.themebg_sel button,.themebg .del,.bgPosition,.bgPosition a.select,.D2 .color,.palettes .mask,.themeDiy .pages a{background:url(http://mat1.gtimg.com/www/mb/images/skinBg1d.png) no-repeat}.D2 .DTitle{cursor:move;height:36px;overflow:hidden;padding-left:10px;font-family:Simsun;font-size:14px;line-height:35px;font-weight:bold;border-bottom:1px solid #D5D5D5;background-position:0 -34px;background-repeat:repeat-x}.D2 .ico_skin{float:left;margin:9px 5px 0 0;_margin-right:0;background-position:0 -124px}.D2 .close{position:absolute;float:none;top:12px;right:12px;margin:0}.D2 .DWrap{width:586px;padding:1px;border:1px solid #7B828B;background:#fff;filter:progid:DXImageTransform.Microsoft.Shadow(color="#909090",Direction=135,Strength=4);-moz-box-shadow:2px 2px 5px #909090;-webkit-box-shadow:2px 2px 5px #909090}.D2 .pages{width:544px;margin:0 auto;padding:10px 5px 8px;border-bottom:1px dotted #C9C9C9}.D2 .pages .disabled{color:#999;cursor:default;text-decoration:none;background:none}
.funBoxx{text-align:center;background-position:0 -75px;background-repeat:repeat-x}.funBoxx .btn-cancel span{padding:5px 12px;_margin:-1px 0 0 0;_height:15px;}.D2 .btn_save{margin-right:10px}.DtabTitle{height:29px;padding-right:10px;*zoom:1;overflow:hidden;line-height:29px;background-repeat:repeat-x;position:relative;}.DtabTitle .ico-close{position:absolute;right:10px;top:6px;}.DtabTitle ul{float:left}.DtabTitle li{display:inline-block;float:left;margin-left:-1px;border:1px solid #D5D5D5;border-width:0 1px}.DtabTitle li.select{padding:0 15px;background:#fff}.DtabTitle li a{display:block;padding:0 15px}.DtempList{width:556px;height:188px;margin:10px 0 0 20px}.DtempList li{position:relative;float:left;width:129px;height:84px;margin:10px 10px 0 0;color:#fff;line-height:19px;text-align:center;cursor:pointer}.DtempList img{margin:1px;width:121px;height:76px;padding:2px;border:1px solid #DFDFDF}

.DtempList .tempName,.DtempList .mask{position:absolute;z-index:2;left:4px;bottom:4px;width:121px;height:19px}.DtempList .ico_lock{display:none;position:absolute;z-index:2;left:6px;top:6px;width:11px;height:16px;background-position:-20px -125px}.DtempList .mask{z-index:1;background:#000;filter:alpha(opacity:70);opacity:0.7}.DtempList li.hover img{border-color:#32A1CC}.DtempList .select img{margin:0;border:2px solid #32A1CC}.DtempList .locked img{border-color:#5F5F5F!important;background:#fff;filter:alpha(opacity:20);opacity:0.2}.DtempList .locked .ico_lock{display:block}.themeDiy{width:670px;height:213px;margin:20px auto 0;color:#999;}.themebgWrap{float:right;width:283px;height:203px;border:1px solid #DFDFDF;}.themebg_sel{position:relative;height:49px;padding:10px 8px 0;line-height:25px;background:#EBEBEB}.themebg_sel .inputTxt{width:180px;margin-right:5px;border:1px solid #C5C5C5;position:relative;z-index:1;cursor:pointer}.themebg_sel button{width:60px;height:21px;border:0;background-position:0 -145px}.selfilemask{position:absolute;z-index:100;width:20px;height:20px;overflow:hidden;*zoom:1;filter:alpha(opacity:0);opacity:0}.selfilemask input{position:absolute;right:0;height:21px;cursor:pointer}
.themebg_set{;margin:15px auto 0;padding:0 0 0 10px;}.themebg{float:left;position:relative;width:106px;height:106px;padding:2px;border:2px solid #32A1CC;overflow:hidden}.themebg .nobg{cursor:default;height:106px;color:#999;line-height:106px;text-align:center;background-color:#EFEFEF}.themebg .loading{padding-left:16px;background-position:20% 50%}.themebg .imgbg{width:106px;text-align:center;overflow:hidden}.themebg .imgbg img{height:106px}.themebg .del{position:absolute;top:0;right:0;width:18px;height:18px;background-position:-35px -124px}.bgSetting{float:right;padding-top:38px;}.bgPosition{width:150px;height:22px;margin:5px 0;background-position:0 -168px;*margin:3px 0;}.bgPosition a{display:inline-block;width:35px;height:19px;padding-top:1px;margin:1px;color:#333;line-height:19px;text-align:center; vertical-align:middle;_margin:0 0 0 1px;_width:34px;}*+html .bgPosition a{margin:1px 0 0 1px;width:34px;}.bgPosition a:hover{text-decoration:none;background-color:#fdfdfd;color:#333;}.bgPosition a.select,.bgPosition a.select:hover{color:#fff;background-position:-64px -145px}.bgSetting label{margin-right:5px;white-space:nowrap;*margin:0;_margin-right:3px;}.bgSetting label input{vertical-align:-2px;margin:0 3px 0 0;*margin:0 0 0 -3px;_vertical-align:-1px;}.themecolorWrap{position:relative;float:left;width:350px;height:203px;border:1px solid #DFDFDF;overflow-y:scroll;}.themePreview{margin:20px 0 0 0;}.themecolorWrap h4{height:24px;padding-top:3px}/*.themePreview{float:left;}*/.themePreview a{position:relative;float:left;margin:0 0 5px 5px;border:2px solid #fff;width:100px;height:75px;*z-index:9;}.themePreview a:hover,.themePreview a.current{border:2px solid #000;}.themePreview a img{width:100px;height:75px;}.themePreview a span{position:absolute;background:#000;font-weight:normal;color:#fff;width:100px;height:22px;line-height:22px;text-align:center;display:block;bottom:0;left:0;opacity:0.4;filter:alpha(opacity=40);-moz-opacity:0.4;_bottom:-1px;}.D2 .colorBox{height:29px;padding-left:1px}.D2 .color{display:inline-block;width:16px;height:16px;padding:3px;background-position:0 -192px}.D2 .colorBox .select{position:relative;background-position:-24px -192px}.TpreviewBox{width:112px;height:110px;overflow:hidden;*zoom:1;padding:10px;border:1px solid #DFDFDF}.Tmain,.Tface{background:#fff url(http://mat1.gtimg.com/www/mb/images/skinFixmod.png) no-repeat}.Tmain{float:left;width:77px;height:110px;margin-right:-1px}.Tside{float:right;width:34px;height:110px;}.TUIn{width:28px;padding:6px 3px 2px;overflow:hidden;*zoom:1}.Tface{float:left;width:14px;height:14px;margin-bottom:4px;background-position:-81px 0}.Tnums{float:right;width:12px}.Tside .textColor{width:12px;height:3px;overflow:hidden;margin-bottom:1px;background:#9C000D}.Tside .linkColor{clear:both;width:50%;height:2px;overflow:hidden;margin-bottom:2px;background:#FFA869}.Tside .sepLine{height:0;overflow:hidden;border:1px solid;border-width:1px 0}.TsideMod{width:28px;margin:4px auto}.TsideMod .textColor{margin-bottom:3px}.TsideMod .linkColor{width:16px}.ThotList .SA{z-index:0;left:0;top:-5px;*top:-6px;_top:-5px}.ThotList .SA *{width:18px;height:5px}.ThotList .SA span{left:0;top:1px}.ThotList{margin-top:3px;height:12px}.palettelist{float:right;position:relative;width:108px;overflow:hidden}.paletteWrap{height:142px;width:1000px;overflow:hidden}.paletteWrap li{float:left;width:108px}.palettes,.palettes *{display:block;height:27px;overflow:hidden;}.palettes{position:relative;float:left;width:48px;padding:3px;margin:4px 0 10px;cursor:pointer}.palettes .c{float:left;width:8px}.palettes .mask{position:absolute;top:0;left:0;clear:both;width:54px;height:33px;background-position:0 -218px}.paletteWrap .select .mask{background-position:-56px -218px}.D2 .themeDiy .pages{position:absolute;right:4px;bottom:15px;clear:both;width:108px;height:16px;overflow:hidden;padding:0;border:none}.themeDiy .pages *{float:left;margin:0}.themeDiy .pages a{width:20px;height:16px;background-position:-74px -124px}.themeDiy .pages .btn_prev_disabled{background-position:-59px -124px;cursor:default}.themeDiy .pages .btn_next{background-position:-102px -124px}.themeDiy .pages .btn_next_disabled{background-position:-87px -124px;cursor:default}.themeDiy .pageInfo{width:68px;text-align:center}.themeHisWrap{position:absolute;left:15px;bottom:13px;*bottom:17px;height:24px;overflow:hidden;*zoom:1;line-height:25px}.themeHis{float:left;width:16px;height:16px;padding:2px;margin:1px 2px;overflow:hidden;border:1px solid #DFDFDF;background-position:center top;cursor:pointer}.themeHis .Tmain{filter:alpha(opacity=10);opacity:0.1;width:9px;height:16px;background:#fff}.themeHis .Tside{width:6px;height:16px}.themeHisWrap .select{margin:0 1px;border:2px solid #32A1CC}.colorPickerPosition{position:absolute;height:0;margin:-31px 0 0 -222px}</style>

<div class="changestylepop">
     <div class="DWrap">
     	<div class="DLoad" style="width: 586px; height: 308px; display: none; "></div>
     	<div class="DCont" style="">
     		<div class="DtabTitle">
     			<a href="javascript:;" onclick="oSpaceStyle.fCancel();" class="ico-close right"></a>
     			<ul>
					<li class="select"><b>自定义皮肤</b></li>
				</ul>
				<span class="right"></span>
			</div>
			<div class="themeDiy"  style="display:block;">
				<div class="themebgWrap"  style="display:block;">
					<div class="themebg_sel">
						<p>
							<form action="{:U('public/Widget/addonsRequest', array('addon'=>'SpaceStyle', 'hook'=>'saveImageTemp'))}" enctype="multipart/form-data" method="post" id="uploadpic" >
								<input type="file" class="inputTxt" hidefoucs="true" name="pic" onchange="oSpaceStyle.oBackground.fSetImage(this, this.value);">
							</form>
						</p>
						<p>支持2M以内的gif、jpg、jpeg、png图片上传</p>
					</div>
			        <div class="themebg_set">
						<div class="themebg">
							<div class="nobg" id="nobg" <php>if(!empty($pic)):</php>style="display:none;"<php>endif;</php>>未上传图片</div>
							<div class="nobg loading" id="loading" style="display:none;">上传中..</div>
							<div class="imgbg" id="success_img" <php>if(empty($pic)):</php>style="display:none;"<php>endif;</php>>
								<a href="javascript:oSpaceStyle.oBackground.fUnsetImage(this)" class="del" title="删除"></a>
								<img src="{$pic}" id="success_pic" />
							</div>
						</div>
						<div class="bgSetting">
							<p>设置背景图</p>
							<p class="bgPosition">
								<a href="#" rel="left" onclick="return oSpaceStyle.oBackground.fSetPosition(this)">居左</a>
								<a href="#" rel="center" onclick="return oSpaceStyle.oBackground.fSetPosition(this)">居中</a>
								<a href="#" rel="right"  onclick="return oSpaceStyle.oBackground.fSetPosition(this)">居右</a>
							</p>
							<p>
								<label><input type="checkbox" class="check1" name="repeat" onclick="oSpaceStyle.oBackground.fSetRepeat(this);" value="repeat"/>背景平铺</label>
								<label><input type="checkbox" class="check1" name="attachment" onclick="oSpaceStyle.oBackground.fSetAttachment(this);" value="fixed">背景固定</label>
							</p>
						</div>
					</div>
				</div>
				<div class="themecolorWrap">
					<div class="colorPickerPosition"></div>
					<div class="themecolor">
						<div class="themePreview">
							<div class="colorBox ">
							<volist name="defaultStyle" id="vo">
								<a rel="{$key}" href="javascript:;" onclick="oSpaceStyle.fChange('{$key}',$(this));" <php>if($key == $default):</php>class="current"<php>endif;</php>>
									<img src="{$vo.thumb_url}" alt="{$vo.name}" />
									<span>{$vo['name']}</span>
								</a>
							</volist>
							</div>
							<div class="TpreviewBox" style=" float:left; margin-left:60px; display:none;"></div>
						</div>
					</div>
				</div>
			</div>
			<div class="funBoxx">
				<a class="btn-green-small buttonObj" onclick="oSpaceStyle.fSave();" style="margin: 10px;"><span>保存</span></a>
				<a class="btn-green-small buttonObj" onclick="oSpaceStyle.fDefault()" style="margin: 10px;padding:0 5px"><span>恢复默认</span></a>
				<a class="btn-cancel buttonObj" onclick="oSpaceStyle.fCancel();" href="javascript:;" style="margin: 10px;"><span>取消</span></a>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript" src="__THEME__/js/jquery.form.js"></script>
<script type="text/javascript">
var is_upload=0;
var is_save=0;
var defaultStyle = <?php echo json_encode($defaultStyle); ?>;
/**
 * JQuery插件，换肤
 * @author liu21st <liu21st@gmail.com>
 * @version TS3.0
 */
$.extend(oSpaceStyle, {
	/**
	 * 换肤插件相关属性
	 */
	oStyleData: {
		classname: "<?php echo $styleData['classname']; ?>",
		background: {
			color: "<?php echo $styleData['background']['color']; ?>",
			image: "<?php echo $styleData['background']['image']; ?>",
			repeat: "<?php echo $styleData['background']['repeat']; ?>",
			attachment: "<?php echo $styleData['background']['attachment']; ?>",
			position: "<?php echo $styleData['background']['position']; ?>"
		}
	},
	// 是否进行改变
	nIsChange: 0,
	/**
	 * 换肤窗口初始化
	 * @return {[type]}
	 */
	fInitBox: function() {
		var $SpaceStyleBox = this.$SpaceStyleBox;
		var sColor = this.oStyleData.background.color;
		var sImage = this.oStyleData.background.image;
		var sRepeat = this.oStyleData.background.repeat;
		var sAttachment = this.oStyleData.background.attachment;
		var sPosition = this.oStyleData.background.position;

		if(sImage) {
			$('#nobg').hide();
		    $('#success_img').show();
			$('#success_pic').attr('src', sImage);
		}
		("repeat" === sRepeat) && $SpaceStyleBox.find( "input[name='repeat']" ).attr('checked', 'checked' );
		("fixed" === sAttachment) && $SpaceStyleBox.find("input[name='attachment']").attr('checked', 'checked');
		sPosition && $SpaceStyleBox.find( ["a[rel='", sPosition.replace('top ', ''), "']"].join( "" ) ).addClass( "select" );
	},
	/**
	 * 改变样式
	 * @param string type 样式类型
	 * @param object obj 对象
	 * @return void
	 */
	fChange: function(type, obj) {      
        for(var one in defaultStyle) {
            if(one == type) {
				obj.addClass('current');
			} else {
				$('a[rel="'+one+'"]').removeClass('current');
            }
        }
		 
		var path = SITE_URL+'/addons/plugin/SpaceStyle/themes/'+type+'/style.css';
		
		if(is_upload == '1') {
			this.oBackground.fUnsetImage();		
			$('body').attr('style', '');
		}	
		$('#change_skin').attr('href',path);
		this.oBackground.fUnsetImage();
		oSpaceStyle.oStyleData.classname = type;
		// 获取自定义设置
		var Images = 'top '+$('a.select').attr('rel');
		var repeats = $('input[name=\'repeat\']').attr('checked');
		if(repeats) {
	  		var repeat = 'repeat';
		} else {
	  		var repeat = 'no-repeat';
		}
		var fix = $('input[name=\'attachment\']').attr('checked');
		if(fix) {
		  var fix_Ed = 'fixed';
		} else {
		  var fix_Ed = 'scroll';
		}
		$('#body_page').css({
			"background-position":""+Images+"",
			"background-repeat":""+repeat+"",
			"background-attachment":""+fix_Ed+""
		});
		this.nIsChange = 1;
		return true;
    },
    /**
     * 样式背景设置
     */
    oBackground: {
    	fSetColor: function() {
        	oSpaceStyle.nIsChange = 1;
    	},
		fSetImage: function(o, str) {
			var d = /\.[^\.]+$/.exec(str).toString().toLowerCase();
			if(d != '.jpg' && d != '.jpeg' && d != '.png' && d != '.gif') {
				ui.error('仅支持【jpg,png,gif】后缀文件');
				$(o).val('');
			} else {
				var options = {
					success: function(txt) {
						if(txt.status == 1) {
					    	var Images = 'top '+$('a.select').attr('rel');
							var repeats = $('input[name=\'repeat\']').attr('checked');
							if(repeats) {
						  		var repeat = 'repeat';
							} else {
						  		var repeat = 'no-repeat';
							}
							var fix = $('input[name=\'attachment\']').attr('checked');
							if(fix) {
							  var fix_Ed = 'fixed';
							} else {
							  var fix_Ed = 'scroll';
							}
							
						    $('#success_img').show();
							$('#success_pic').attr('src', txt.info);
						    $('#loading').hide();
							$('#body_page').css({
								"background-image":"url("+txt.info+")",
								"background-position":""+Images+"",
								"background-repeat":""+repeat+"",
								"background-attachment":""+fix_Ed+""
							});
							is_upload=1;
		    				oSpaceStyle.oStyleData.background.image = txt.info;
						} else {
							ui.error(txt.info);
							$('input[type="file"]').val('');
							$('#nobg').show();
							$('#loading').hide();
						}
					},
					dataType: 'json'
				}
				$('#uploadpic').ajaxSubmit(options);
				$('#nobg').hide();			   
				$('#success_img').hide();
				$('#loading').show();
			}
        	oSpaceStyle.nIsChange = 1;
		},
		/**
		 * 重置图片
		 * @return void
		 */
		fUnsetImage: function() {
			var imagePath=$('#success_pic').attr('src');

			$('#nobg').show();	 
			$('#loading,#success_img').hide();
			$('input[name=\'pic\']').val('');
			$('#success_pic').attr('src','');	
			is_upload=0;

			$('#change_background').remove();
			$('#body_page').css({"background-image":"","background-position":"","background-repeat":"","background-attachment":""});
        	oSpaceStyle.oStyleData.background.image = '';
        	oSpaceStyle.nIsChange = 1;
		},
		/**
		 * 设置Repeat属性
		 * @param object obj [description]
		 * @return void
		 */
		fSetRepeat: function(obj) {
            var repeats = $('input[name=\'repeat\']').attr('checked');
			if(repeats != undefined){
			  var repeat='repeat';
			}else{
			  var repeat='no-repeat';
			}
			$('#body_page').css('background-repeat',repeat);
        	oSpaceStyle.oStyleData.background.repeat = repeat;
        	oSpaceStyle.nIsChange = 1;
		},
		fSetAttachment: function(obj) {
            var fix = $('input[name=\'attachment\']').attr('checked');
			if(fix != undefined){
			  var fix_Ed="fixed";
			}else{
			  var fix_Ed='scroll';
			}
			$('#body_page').css('background-attachment',fix_Ed);
        	oSpaceStyle.oStyleData.background.attachment = fix_Ed;
        	oSpaceStyle.nIsChange = 1;
		},
		/**
		 * 设置Position属性
		 * @param object obj [description]
		 * @return void
		 */
		fSetPosition: function(obj) {
			$('a.select').removeClass('select');
			$(obj).addClass('select');
			var rel = $(obj).attr('rel');
			var position = 'top ' + rel;
			$('#body_page').css('background-position', position);
			oSpaceStyle.oStyleData.background.position = position;
			oSpaceStyle.nIsChange = 1;
			return false;
		}
    },
    /**
     * 恢复默认操作
     * @return void
     */
	fDefault: function() {
		this.oStyleData.classname = '';
		this.oStyleData.background.color = '';
		this.oStyleData.background.image = '';
		this.oStyleData.background.repeat = '';
		this.oStyleData.background.attachment = '';
		this.oStyleData.background.position = '';
		this.fSave();
		setTimeout(function() {
			window.location.reload() 
		}, 800);
	},
	/**
	 * 保存样式操作
	 * @return void
	 */
	fSave: function() {
		var oSpaceStyle = this;
		$.post("{:Addons::createAddonUrl('SpaceStyle', 'saveStyle')}", oSpaceStyle.oStyleData, function(txt) {
			if (txt.status) {
				oSpaceStyle.fHideBox();
				ui.success(txt.info);
				is_save = 1;
        		oSpaceStyle.nIsChange = 0;
			} else {
				ui.error(txt.info);
			}
			oSpaceStyle = null;
		}, 'json');
	},
	/**
	 * 取消操作
	 * @return void
	 */
	fCancel: function() {
		switch(this.nIsChange) {
			case 1:
				window.location.reload();
			default:
				oSpaceStyle.fHideBox();
		}
	}
});
/**
 * 初始化载入样式
 * @return void
 */
$(document).ready(function(){
	oSpaceStyle.fInitBox();
});
</script>